# R2 + D1 でブログ本文とメタ情報を分離保存する設計

## 概要
本ブログは現在、`src/index.tsx` 内の配列に記事データをハードコードしている。これを以下の責務分離に置き換える。

- 本文（Markdown）は Cloudflare R2 に保存
- メタ情報（タイトル、slug、公開日、抜粋など）は Cloudflare D1 に保存

この設計は、現行の機能（一覧表示、slug ルーティング、簡易 Markdown レンダリング、SSR）を維持しつつ、ストレージの永続化と拡張性を確保することを目的とする。

## 現状の機能理解（README より）
- Hono + React の SSR でブログをレンダリング
- `/` で最近の記事一覧
- `/posts/:slug` で記事詳細
- Markdown → HTML の簡易変換
- `PostCard` コンポーネントによる一覧表示

## 目的
- 記事本文を R2 に保存し、容量・配信効率を確保する
- メタ情報を D1 で管理し、一覧・検索・ソート・更新を容易にする
- SSR での読み取りパスを明確にし、将来の執筆・更新フローへ拡張可能にする

## 非目的
- 管理画面や投稿 UI の実装
- 高度な Markdown 処理やリッチエディタ導入
- 多言語・タグ・全文検索などの追加機能

## 全体アーキテクチャ

### 主要コンポーネント
- Hono (Pages/Workers) が SSR を担当
- D1 が記事メタ情報を保持
- R2 が Markdown 本文を保持

### データ参照の流れ
1. `/` では D1 から最新記事のメタ情報を取得
2. `/posts/:slug` では D1 からメタ情報と本文キーを取得
3. R2 から Markdown を取得し、HTML に変換して返却

## データモデル

### D1: posts テーブル
現行の `Post` 型（id, title, slug, date, excerpt, content）に対応し、本文は R2 へ外出しする。

```sql
CREATE TABLE posts (
  id TEXT PRIMARY KEY,
  slug TEXT NOT NULL UNIQUE,
  title TEXT NOT NULL,
  excerpt TEXT NOT NULL,
  published_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'published',
  content_key TEXT NOT NULL,
  content_type TEXT NOT NULL DEFAULT 'text/markdown',
  content_length INTEGER,
  content_hash TEXT
);

CREATE INDEX posts_published_at_idx ON posts (published_at DESC);
```

### R2: オブジェクトキー設計
- 基本キー形式: `posts/{slug}.md`
- 変更・差し替えを考慮して、`content_key` は D1 に保持
- ファイルは Markdown とし、拡張子で種類を明示

## 読み取りパス

### 一覧ページ (`/`)
- D1 クエリ: 公開済み記事のみを `published_at` 降順で取得
- 取得フィールド: `id`, `slug`, `title`, `excerpt`, `published_at`
- `PostCard` はこのメタ情報だけで描画可能

### 記事詳細 (`/posts/:slug`)
- D1 クエリ: `slug` で 1 件取得
- R2 から `content_key` を使用して本文取得
- 取得した Markdown を HTML に変換
- 404 条件
  - D1 に該当 slug が無い
  - R2 に本文が存在しない

## 書き込みパス（運用想定）
現段階では管理 UI を持たないため、運用は以下のいずれかを想定する。

- ローカルで Markdown を作成し R2 へアップロード
- D1 にメタ情報を登録（スクリプト or Wrangler 経由）

### 更新フロー（推奨）
1. 新しい Markdown を R2 にアップロード
2. `content_hash` と `content_length` を取得
3. D1 の該当レコードを更新

### 整合性
- 先に R2 を更新してから D1 を更新する
- D1 更新失敗時は R2 の最新オブジェクトを削除する運用ルールを用意

## キャッシュ戦略
- 一覧ページ: `Cache-Control: public, max-age=60, stale-while-revalidate=300`
- 記事詳細: `ETag` を R2 の `etag` か `content_hash` に合わせる
- Hono のレスポンスは Cloudflare CDN によるキャッシュを前提

## エラーハンドリング
- D1 クエリ失敗: 500
- R2 取得失敗: 500（または 404 にフォールバック）
- 取得成功でも本文が空の場合は 404

## セキュリティと公開範囲
- R2 バケットは非公開
- Worker からの読み取りのみ許可
- 書き込みは管理フロー限定（今後の拡張）

## 移行手順（実装時の流れ）
1. D1 を作成し `posts` テーブルを追加
2. R2 バケットを作成
3. `wrangler.toml` に D1/R2 バインディングを追加
4. 既存のハードコードデータを R2 + D1 に移行
5. `src/index.tsx` のデータ取得を D1/R2 に切り替え

## 今後の拡張候補
- `tags` テーブル追加
- `draft` ステータスによる非公開管理
- HTML 事前生成（R2 に HTML 保存）
- 管理 UI（投稿・編集）
- OGP や SEO メタの保存
